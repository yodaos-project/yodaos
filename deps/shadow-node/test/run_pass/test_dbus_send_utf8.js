'use strict';

var assert = require('assert');
var dbus = require('dbus');

var myservice = dbus.registerService('session', 'org.myservice');
var myobject = myservice.createObject('/org/myobject');
var myiface = myobject.createInterface('test.dbus.myservice.testSendUtf8');
var bus = dbus.getBus();

myiface.addMethod('test', {
  in: [dbus.Define(String)],
  out: [dbus.Define(String)]
}, (text, cb) => {
  cb(null, text);
});
myiface.update();

function test(str) {
  return new Promise((resolve, reject) => {
    bus.callMethod(
      'org.myservice',
      '/org/myobject',
      'test.dbus.myservice.testSendUtf8', 'test', 's', [str], (err, res) => {
        try {
          assert.strictEqual(err, null);
          assert.strictEqual(res, str);
          return resolve(true);
        } catch (err) {
          return reject(err);
        }
      });
  });
}

Promise.all([
  test('foobar'),
  test('ğŸ˜„'),
  test('ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜‡ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜ŒğŸ˜ğŸ˜˜ğŸ˜—ğŸ˜™ğŸ˜šğŸ˜‹ğŸ˜›ğŸ˜ğŸ˜œğŸ¤ªğŸ¤¨ğŸ§ğŸ¤“'),
  test('ğŸ¶ğŸ±ğŸ­ğŸ¹ğŸ°ğŸ¦ŠğŸ»ğŸ¼ğŸ¨ğŸ¯ğŸ¦ğŸ®ğŸ·ğŸ½ğŸ¸ğŸµğŸ™ˆğŸ™‰ğŸ™ŠğŸ’ğŸ”ğŸ§ğŸ¦ğŸ¤ğŸ£ğŸ¥ğŸ¦†ğŸ¦…ğŸ¦‰'),
  test('ğŸ¦‡ğŸºğŸ—ğŸ´ğŸ¦„ğŸğŸ›ğŸ¦‹ğŸŒğŸšğŸğŸœğŸ¦—ğŸ•·ğŸ•¸ğŸ¦‚ğŸ¢ğŸğŸ¦ğŸ¦–ğŸ¦•ğŸ™ğŸ¦‘ğŸ¦ğŸ¦€ğŸ¡ğŸ ğŸŸğŸ¬'),
  test('ğŸğŸğŸğŸŠğŸ‹ğŸŒğŸ‰ğŸ‡ğŸ“ğŸˆğŸ’ğŸ‘ğŸğŸ¥¥ğŸ¥ğŸ…ğŸ†ğŸ¥‘ğŸ¥¦ğŸ¥’ğŸŒ¶ğŸŒ½ğŸ¥•ğŸ¥”ğŸ ğŸ¥ğŸğŸ¥–ğŸ¥¨'),
  test('âš½ï¸ğŸ€ğŸˆâš¾ï¸ğŸ¾ğŸğŸ‰ğŸ±ğŸ“ğŸ¸ğŸ¥…ğŸ’ğŸ‘ğŸâ›³ï¸ğŸ¹ğŸ£ğŸ¥ŠğŸ¥‹ğŸ½â›¸ğŸ¥ŒğŸ›·ğŸ¿â›·ğŸ‚'),
  test('ğŸš—ğŸš•ğŸš™ğŸšŒğŸšğŸğŸš“ğŸš‘ğŸš’ğŸšğŸššğŸš›ğŸšœğŸ›´ğŸš²ğŸ›µğŸğŸš¨ğŸš”ğŸšğŸš˜ğŸš–ğŸš¡ğŸš ğŸšŸğŸšƒğŸš‹ğŸšğŸšğŸš„'),
  test('âŒšï¸ğŸ“±ğŸ“²ğŸ’»âŒ¨ï¸ğŸ–¥ğŸ–¨ğŸ–±ğŸ–²ğŸ•¹ğŸ—œğŸ’½ğŸ’¾ğŸ’¿ğŸ“€ğŸ“¼ğŸ“·ğŸ“¸ğŸ“¹ğŸ¥ğŸ“½ğŸğŸ“â˜ï¸ğŸ“ŸğŸ“ ğŸ“ºğŸ“»ğŸ™ğŸšğŸ›'),
  test('â¤ï¸ğŸ§¡ğŸ’›ğŸ’šğŸ’™ğŸ’œğŸ–¤ğŸ’”â£ï¸ğŸ’•ğŸ’ğŸ’“ğŸ’—ğŸ’–ğŸ’˜ğŸ’ğŸ’Ÿâ˜®ï¸âœï¸â˜ªï¸ğŸ•‰â˜¸ï¸âœ¡ï¸ğŸ”¯ğŸ•â˜¯ï¸â˜¦ï¸ğŸ›â›â™ˆï¸â™‰ï¸â™Šï¸â™‹ï¸â™Œï¸â™ï¸â™ï¸â™ï¸â™ï¸â™‘ï¸â™’ï¸'),
  test('â†’â‡’âŸ¹â‡¨â‡¾â¾â‡¢â˜›â˜â”âœâ™â›âââŸâ â¡ï¸â¢â£â¤â¥â¦â§â¨â¥¤â‡€â‡â¥›â¥Ÿâ‡°â©âªâ«â¬â­â®â¯â±â²â³âµâ¸â»âºâ¼â½âŸ¶â‡‰â‡¶â‡›â‡â¤ƒâ†›â†â¤³â†£â† â†¦'),
  test('Â¡!Â¿?â¸˜â€½â€œâ€â€˜â€™â€›â€Ÿ.,â€šâ€^Â°Â¸Ë›&Â¶â€ â€¡@%â€°â€±Â¦|/Ë‰Ë†Ë˜Ë‡â€¼ï¸â‡âˆâ‰ï¸â›âœâââ¢â£â¡'),
  test('â˜€ï¸â˜¼â˜½â˜¾â˜ï¸â˜‚ï¸â˜”ï¸â˜ƒï¸â˜…â˜†â­ï¸â˜‡â˜ˆâ™ ï¸â™£ï¸â™¥ï¸â™¦ï¸â™¤â™§â™¡â™¢â™šâ™›â™œâ™˜â™—â™–â™•â™”â™Ÿâ™â™â™™âš€âšâš‚âšƒâš„âš…â˜»âœâœï¸âœâœï¸âœŒï¸âš½ï¸âš¾ï¸âœ„âœƒ'),
  test('ğŸ€¥ğŸ€¦ğŸ€¨ğŸ€©ğŸ€ªğŸ€¡ğŸ€ ğŸ€ŸğŸ€ğŸ€ğŸ€œğŸ€›ğŸ€šğŸ€™ğŸ€˜ğŸ€—ğŸ€–ğŸ€ğŸ€ğŸ€ğŸ€ŒğŸ€‹ğŸ€‚ğŸ€ƒğŸ€…ğŸ€†ğŸ€‡ğŸ€ˆğŸ€‰ğŸ€ŠğŸ€ğŸ€€ğŸ€„ï¸'),
  test('+âˆ’-Ã—Ã·Â±âˆ“âˆ”â„¶â„µâˆâˆâˆªâˆ©Â¬=â„·â„¸â„â„‡âˆ€âˆâˆ‚â„®âˆƒâˆ„âˆ…âˆ†âˆ‡âŠ‚âŠƒâŠ„âŠ…âŠ†âŠ‡âŠˆâŠ‰âŠŠâŠ‹âˆˆâˆ‰âˆŠâˆ‹âˆŒâˆâˆ§âˆ¨<'),
  test('Â®Â©â„—â„¢â„ â„–ÂªÂºâ„”â„¥â„¨â„¬â„ŠÂµâ„¦â„¹ï¸â„Œâ„‘â„â„³â„ƒâ„‰â„€â„â„…â„†'),
  test('Ã€ÃÃ‚ÃƒÄ€Ä‚È¦Ã„áº¢Ã…Ã†â±°Ç¼Ç¢á¸‚ÆÄ†ÉƒÆ„ÄŒÆ‡Ã‡á¸ˆÈ»ÄÆ‰Æ‹ÃˆÃ‰Æ‘á¸ÆÆÉ†Äœá¸ Ä Ç¦á¸¨á¸ªÄ¨Ä®Éˆá¸°Ç¨á¸´Ä»á¸¼Ä¿Åá¸¾á¹‚â±®ÆœÅ…á¹Šá¹ˆÈ Ã•ÅÆ Å”Å˜Æ¦ÉŒ'),
]).then(
  () => {
    bus.destroy();
    console.log('send utf8 test is ok');
  },
  (err) => {
    bus.destroy();
    assert.fail('failure on testing');
  }
);
